@page "/admin/orders"
@attribute [Authorize(Roles = "CanteenStaff, CanteenManager, SystemAdmin")]

@inject OrderService OrderService
@inject ToastService ToastService

<h3>Quản lý Đơn hàng</h3>

@if (orders == null)
{
    <p><em>Đang tải danh sách đơn hàng...</em></p>
}
else if (!orders.Any())
{
    <p><em>Hiện không có đơn hàng nào cần xử lý.</em></p>
}
else
{
    <div class="accordion" id="ordersAccordion">
        @foreach (var order in orders.OrderBy(o => o.OrderDate))
        {
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-@order.OrderId">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@order.OrderId">
                        Đơn hàng #@order.OrderId - @order.OrderDate.ToLocalTime().ToString("HH:mm dd/MM/yyyy") - <span class="badge @GetStatusBadgeClass(order.Status) ms-2">@order.Status</span>
                    </button>
                </h2>
                <div id="collapse-@order.OrderId" class="accordion-collapse collapse" data-bs-parent="#ordersAccordion">
                    <div class="accordion-body">
                        <h5>Chi tiết món ăn:</h5>
                        <ul>
                            @foreach (var item in order.OrderItems)
                            {
                                <li>@item.Quantity x @item.MenuItem.Name - @(item.MenuItem.Price.ToString("N0")) VNĐ</li>
                            }
                        </ul>
                        <hr />
                        <p><strong>Tổng tiền: @order.TotalPrice.ToString("N0") VNĐ</strong></p>
                        <p><strong>Người đặt: @order.User.FullName</strong></p>
                        <div class="mt-3">
                            <strong>Cập nhật trạng thái:</strong>
                            <select class="form-select w-auto d-inline-block ms-2" @onchange="(e) => HandleStatusChange(order, e.Value.ToString())">
                                <option value="">-- Chọn trạng thái --</option>
                                @if (order.Status == "Paid")
                                {
                                    <option value="Preparing">Chuẩn bị</option>
                                }
                                @if (order.Status == "Preparing")
                                {
                                    <option value="Ready for Pickup">Sẵn sàng</option>
                                }
                                @if (order.Status == "Ready for Pickup")
                                {
                                    <option value="Completed">Hoàn thành</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Order>? orders;
    private bool _hasLoadedData = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasLoadedData)
        {
            _hasLoadedData = true;
            await LoadOrders();
            StateHasChanged();
        }
    }

    private async Task LoadOrders()
    {
        try
        {
            orders = await OrderService.GetProcessableOrdersAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading processable orders: {ex.Message}");
            ToastService.ShowToast("Lỗi khi tải đơn hàng.", ToastLevel.Danger);
        }
    }

    private async Task HandleStatusChange(Order order, string newStatus)
    {
        if (string.IsNullOrEmpty(newStatus)) return;

        // Nhận về đối tượng order mới, đã được cập nhật đầy đủ từ API
        var updatedOrder = await OrderService.UpdateOrderStatusAsync(order.OrderId, newStatus);

        if (updatedOrder != null)
        {
            ToastService.ShowToast($"Cập nhật đơn hàng #{order.OrderId} thành công!");

            // Tìm vị trí của đơn hàng cũ trong danh sách
            var index = orders.FindIndex(o => o.OrderId == order.OrderId);
            if (index != -1)
            {
                if (updatedOrder.Status == "Completed" || updatedOrder.Status == "Cancelled")
                {
                    // Nếu đã hoàn thành/hủy thì xóa khỏi danh sách
                    orders.RemoveAt(index);
                }
                else
                {
                    // Nếu chưa, thay thế đơn hàng cũ bằng đơn hàng mới đã có đầy đủ OrderItems
                    orders[index] = updatedOrder;
                }
            }
            StateHasChanged();
        }
        else
        {
            ToastService.ShowToast("Cập nhật thất bại.", ToastLevel.Danger);
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Paid" => "bg-info text-dark",
            "Preparing" => "bg-primary",
            "Ready for Pickup" => "bg-success",
            _ => "bg-secondary"
        };
    }
}